<div class="mt-4 shift-250">
  <!-- Profile Header -->
  <div class="row mb-5">
    <div class="col-12 col-md-4 text-center">
      <div class="rounded-circle bg-secondary text-white d-flex align-items-center justify-content-center mx-auto" style="width: 150px; height: 150px;">
        <% if @user.photo.attached? %>
          <%= image_tag @user.photo.key, style: "width: 150px; height: 150px;" %>
        <% else %>
          <img src="https://cdn-icons-png.flaticon.com/512/6858/6858485.png" style="width: 150px; height: 150px;">
          <i class="bi bi-person" style="font-size: 4rem;"></i>
        <% end %>
      </div>
    </div>
    <div class="col-12 col-md-8 mt-3" data-controller="follow" data-user-id="<%= @user.id %>">
      <div class="d-flex align-items-center mb-3">
        <% if current_user == @user %>
          <%= link_to 'Edit Profile', edit_profile_path(@user), class: 'btn btn-outline-secondary px-4' %>
        <% else %>
          <div id="follow-unfollow-container">
            <% if current_user.following.include?(@user) %>
              <button class="btn btn-outline-dark px-4" data-action="click->follow#unfollow" data-follow-target="button">Following</button>
            <% else %>
              <button class="btn px-5" data-action="click->follow#follow" data-follow-target="button">Follow</button>
            <% end %>
          </div>
        <% end %>
        <%= button_to "Start Chat", create_chat_path(recipient_id: @user.id), method: :post, class: "btn btn-primary" %>
        <%= button_to "Logout", destroy_user_session_path, method: :delete, class: "btn btn-outline-danger ms-2" %>
      </div>
      <div class="d-flex mb-3">
        <div class="me-4"><strong><%= @user.posts.count %></strong> posts</div>
        <div class="me-4">
          <%= link_to followers_profile_path(@user), class: "text-decoration-none" do %>
            <strong data-follow-target="county"><%= @user.followers.count %></strong> followers
          <% end %>
        </div>
        <div class="me-4">
          <%= link_to following_profile_path(@user), class: "text-decoration-none" do %>
            <strong><%= @user.following.count %></strong> following
          <% end %>
        </div>
      </div>
      <h2 class="mb-0 me-5"><%= @user.username %></h2>
      <div class="mb-3">
        <% if @user.bio.present? %>
          <p class="mb-0"><%= @user.bio %></p>
        <% else %>
          <p class="text-muted mb-0">No bio available.</p>
        <% end %>
      </div>
    </div>
  </div>

  <!-- Posts Grid -->
  <div class="container">
    <div class="row border-top pt-4 justify-content-center">
      <% @user.posts.each do |post| %>
        <div class="col-12 col-md-4 mb-4">
          <div class="card h-100">
            <div class="bg-light d-flex align-items-center justify-content-center" style="height: 300px;">
              <% if post.photo.attached? %>
                <%= link_to "#", data: { bs_toggle: "modal", bs_target: "#postModal#{post.id}" } do %>
                  <%= cl_image_tag post.photo.key, height: 300, width: 400, crop: :fill, class: "constrain-image" %>
                <% end %>
              <% else %>
                <p class="text-muted">No media available</p>
              <% end %>
            </div>
          </div>
        </div>

        <!-- Modal for each post -->
        <div class="modal fade" id="postModal<%= post.id %>" tabindex="-1" aria-labelledby="postModalLabel<%= post.id %>" aria-hidden="true">
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                <h1 class="modal-title fs-5" id="postModalLabel<%= post.id %>">Post</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                <h5 class="card-title">
                  <%= link_to "@#{post.user.username}", user_path(post.user), class: "text-decoration-none" %>
                </h5>
                <% if post.photo.attached? %>
                  <%= cl_image_tag post.photo.key, class: "img-fluid" %>
                <% end %>
                <p class="card-text"><%= post.content %></p>
                <p class="card-text">
                  <small class="text-muted">Posted <%= time_ago_in_words(post.created_at) %> ago</small>
                </p>
              </div>
              <div class="card-body">
                <div class="like-comment-share">
                  <div class="d-flex justify-content-left align-items-center mb-2 gap-3">
                    <!-- Like Icon -->
                    <div id="<%= dom_id(post, :like) %>" data-controller="like" data-like-post-id-value="<%= post.id %>" data-like-liked-value="<%= user_signed_in? && current_user.likes.exists?(post: post) %>">
                      <i class="fa fa-heart <%= user_signed_in? && current_user.likes.exists?(post: post) ? 'liked text-danger' : '' %>" data-action="click->like#toggleLike" style="cursor: pointer;"></i>
                    </div>

                    <!-- Comment Icon -->
                    <a href="#" class="text-dark" data-bs-toggle="collapse" data-bs-target="#comments-<%= post.id %>" title="Comments">
                      <i class="fa fa-comment" style="font-size: 1.2rem;"></i>
                    </a>

                    <!-- Share Icon -->
                    <a href="#" class="text-dark" data-bs-toggle="collapse" data-bs-target="#share-<%= post.id %>" title="Share">
                      <i class="fa fa-share" style="font-size: 1.2rem;"></i>
                    </a>
                  </div>

                  <div class="collapse mt-3" id="comments-<%= post.id %>">
                    <%= form_with(model: [post, Comment.new], local: false) do |form| %>
                      <div class="input-group mb-2">
                        <%= form.text_field :content, placeholder: "Write a comment...", class: "form-control" %>
                        <%= form.submit "Post", class: "btn btn-primary" %>
                      </div>
                    <% end %>

                    <% post.comments.each do |comment| %>
                      <div class="mb-2">
                        <strong><%= comment.user.username %>:</strong>
                        <%= comment.content %>
                        <small class="text-muted d-block"><%= time_ago_in_words(comment.created_at) %> ago</small>
                      </div>
                    <% end %>
                  </div>

                  <!-- Share Section -->
                  <div class="collapse" id="share-<%= post.id %>">
                    <div class="d-flex justify-content-around">
                      <a href="https://www.facebook.com/sharer/sharer.php?u=<%= post_url(post) %>" target="_blank" class="btn btn-sm btn-primary">
                        <i class="fab fa-facebook-f"></i> Facebook
                      </a>

                      <a href="https://www.linkedin.com/sharing/share-offsite/?url=<%= post_url(post) %>" target="_blank" class="btn btn-sm btn-secondary">
                        <i class="fab fa-linkedin-in"></i> LinkedIn
                      </a>
                      <a href="https://wa.me/?text=<%= CGI.escape(post_url(post)) %>" target="_blank" class="btn btn-sm btn-success">
                        <i class="fab fa-whatsapp"></i> WhatsApp
                      </a>
                    </div>
                  </div>
                </div>

                <!-- Delete Button -->
                <% if current_user == post.user %>
                  <%= button_to post_path(post), method: :delete, data: { turbo_confirm: "Are you sure you want to delete this post?" }, class: "btn btn-sm btn-danger" do %>
                    <i class="fa fa-trash"></i> Delete
                  <% end %>
                <% end %>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
              </div>
            </div>
          </div>
        </div>
      <% end %> <!-- End of @user.posts.each -->
    </div> <!-- End of Posts Grid -->
  </div>
</div>
